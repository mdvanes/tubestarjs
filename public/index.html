<html>
  <head>
    <style>
      html,
      body {
        background-color: darkslategray;
        color: white;
        font-weight: bold;
        font-family: sans-serif;
        height: 100%;
        margin: 0;
      }

      main {
        display: flex;
        height: 100%;
        align-items: center;
      }

      main > ul {
        flex: 0.5;
        text-align: center;
        list-style-type: none;
      }

      main > div {
        flex: 1;
      }
    </style>
    <title>Tubestar.js</title>
  </head>
  <body>
    <main>
      <ul>
        <li id="topic">
          topic:
          <span></span>
        </li>

        <li id="payloadLength">
          payload length:
          <span></span>
        </li>

        <li id="payload">
          payload:
          <span></span>
        </li>
      </ul>
      <div id="linechart" style="width: 600px; height: 400px"></div>
    </main>

    <script src="/vendor/echarts.js"></script>

    <script type="text/javascript">
      const source = new EventSource("/events");

      const vehiclePos = {};

      const chartDom = document.getElementById("linechart");
      const myChart = echarts.init(chartDom);
      const data = [];
      const option = {
        xAxis: {
          type: "category",
        },
        yAxis: {
          type: "value",
        },
        series: [
          {
            data,
            type: "line",
            smooth: true,
          },
        ],
      };

      option && myChart.setOption(option);

      source.addEventListener("message", (message) => {
        const { topic, payloadLength, payload } = JSON.parse(event.data);

        document.querySelector("#topic > span").innerHTML = topic;
        document.querySelector("#payloadLength > span").innerHTML = payloadLength;

        data.push(payloadLength);
        myChart.setOption({
          series: [
            {
              data,
              type: "line",
              smooth: true,
            },
          ],
        });

        const onroute =
          payload["tmi8:VV_TM_PUSH"]["tmi8:KV6posinfo"]["tmi8:ONROUTE"];

        if (onroute && onroute.map) {
          onroute.map((pos) => {
            const owner = pos["tmi8:dataownercode"]["_text"];
            const id = pos["tmi8:vehiclenumber"]["_text"];
            const x = pos["tmi8:rd-x"]["_text"];
            const y = pos["tmi8:rd-y"]["_text"];
            console.log(owner, id, x, y);
            const key = `${owner}${id}`;

            if (!vehiclePos[key]) {
              vehiclePos[key] = [{ x, y }];
            } else {
              vehiclePos[key].push({ x, y });
            }
          });
          document.querySelector("#payload > span").innerHTML = JSON.stringify(vehiclePos);
        }
      });
    </script>
  </body>
</html>
